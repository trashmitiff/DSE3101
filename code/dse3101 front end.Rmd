---
title: "Public Transport Accessibility Dashboard"
author: 
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
library(shiny)
library(shinydashboard)
library(sf)
library(leaflet)
library(lubridate)
library(readr)
library(dplyr)
library(ggplot2)
library(plotly)
library(DT)
library(stringr)
```

Data

```{r message=FALSE, warning=FALSE}
# Load datasets
data_path <- "../data/"
future_com_hub_score <- read_csv(file.path(data_path, "future_com_hub_score_scaled.csv"))
future_combined <- read_csv(file.path(data_path, "final_combined_com_v2.csv"))
final_com_pca <- read_csv(file.path(data_path, "final_combined_com_pca.csv"))
subzone_data <- read_csv(file.path(data_path, "subzone_final.csv"))
subzone_data <- st_as_sf(subzone_data, wkt = "geog_boundary", crs = 4326)

# Merge PCA data with spatial subzone data
commuter_subzone_data <- subzone_data %>%
  left_join(final_com_pca, by = "subzone_name") %>%
  mutate(relative_commuter_score = round(ifelse(is.na(relative_commuter_score), 0, relative_commuter_score), 2)) %>%
  rename(planning_area_name = planning_area_name.x) %>%
  select(subzone_name, commuter_score, relative_commuter_score, geog_boundary, planning_area_name)

# Fix invalid geometries in commuter_subzone_data
commuter_subzone_data <- commuter_subzone_data %>%
  mutate(geog_boundary = st_make_valid(geog_boundary)) %>%
  filter(st_is_valid(geog_boundary))

# Now compute average commuter score per planning area
commuter_planning_area <- commuter_subzone_data %>%
  group_by(planning_area_name) %>%
  summarise(avg_commuter_score = round(mean(relative_commuter_score, na.rm = TRUE), 2)) %>%
  ungroup() %>%
  select(planning_area_name, avg_commuter_score)

# Creating a new dataframe to get rid of geog_boundary for table
commuter_data4table <- commuter_subzone_data %>%
  select(subzone_name, planning_area_name, relative_commuter_score) %>%
  rename(
    "Subzone" = subzone_name,
    "Planning Area" = planning_area_name,
    "Commuter Hub Score" = relative_commuter_score
  ) %>%
  group_by(Subzone, `Planning Area`) %>%
  summarise(`Commuter Hub Score` = round(mean(`Commuter Hub Score`, na.rm = TRUE), 2), .groups = 'drop') %>%
  st_drop_geometry() %>%
  as.data.frame() %>%
  arrange(desc(`Commuter Hub Score`)) 

```
UI Commuter Hub
```{r}
ui <- dashboardPage(
  dashboardHeader(title = "Public Transport Accessibility"),
  dashboardSidebar(
    sidebarMenu(
      menuItem("Commuter Hub Map", tabName = "commuter_hub", icon = icon("map")),
      menuItem("Transport Accessibility", tabName = "accessibility", icon = icon("bus")),
      menuItem("Simulation Mode", tabName = "simulation", icon = icon("cogs"))
    )
  ),
  dashboardBody(
    fluidRow(
      box(title = "Notes", width = 12, status = "info", solidHeader = TRUE,
          p("🧠 Understanding the Commuter Hub Density Score:"),
          tags$ul(
            tags$li("The commuter hub score is derived based on various transport factors including bus and train inflow/outflow volumes. A higher score indicates a location with a high movement of commuters, suggesting it as a major transport hub. The maximum score is 1, and the minimum is 0.")),
          p("📌 How to use this dashboard:"),
          tags$ul(
            tags$li("🗺️ Click on the Map to explore commuter hub density visually."),
            tags$li("🔍 Use the search bar to filter subzones or planning areas of your choice."),
            tags$li("📊 Check the Chart to compare average commuter hub scores."),
          ))),
    tabItems(
      tabItem(tabName = "commuter_hub",
  fluidRow(
    column(width = 6,
           box(title = "🗺️ Commuter Hub Map", width = NULL, height = "800px",
               leafletOutput("commuter_map", height = "700px"),
               )
    ),
    column(width = 6,
           box(title = "📊 Commuter Hub Data", width = NULL, height = "800px",
               tabsetPanel(
                 tabPanel("Table", 
                          textInput("subzone_search", "🔍 Search for an Area:", ""),
                          DTOutput("commuter_table"), height ="700px"),
                 tabPanel("Chart", 
                          plotlyOutput("commuter_chart", height = "700px"))),
               )
               ))))))

```

Server Commuter Hub
```{r}
server <- function(input, output, session) {
    
  # Commuter Hub Table
  output$commuter_table <- renderDT({
      # when search input is empty, still shows all data
      if (is.null(input$subzone_search) || input$subzone_search == "") {commuter_data4table
      } else {
          commuter_data4table <- commuter_data4table %>%
            filter(
              str_detect(`Subzone`, regex(input$subzone_search, ignore_case = TRUE)) |
              str_detect(`Planning Area`, regex(input$subzone_search, ignore_case = TRUE))
            )
      }
      datatable(commuter_data4table, 
                options = list(pageLength = 10, searching = FALSE), 
                rownames = FALSE, 
                filter = "none")
  })
  
  # Commuter Hub Map
  output$commuter_map <- renderLeaflet({
    leaflet(commuter_subzone_data) %>%
      addTiles() %>%
      addPolygons(
        fillColor = ~colorQuantile("Reds", relative_commuter_score)(relative_commuter_score), 
        fillOpacity = 0.7,
        color = "white",
        weight = 1,
        popup = ~paste0("<b>", subzone_name, "</b><br>Commuter Score: ", relative_commuter_score)
      ) %>%
      addLegend(position = "bottomright",
        colors = c("#B71C1C", "#D32F2F", "#EF5350", "#FFCDD2", "#FFEBEE"),
        labels = c("Very High", "High", "Medium", "Low", "Very Low"),
        title = "Commuter Hub Score",
        opacity = 1
      )
  })
  
  # Commuter Hub Chart
  output$commuter_chart <- renderPlotly({
    com_chart <- ggplot(commuter_planning_area, aes(x = reorder(planning_area_name, avg_commuter_score), 
                                        y = avg_commuter_score, 
                                        fill = avg_commuter_score, 
                                        title = "Commuter Hub Density Score",
                                        text = paste("Planning Area:", planning_area_name, 
                                                     "<br>Score:", round(avg_commuter_score, 2)))) +
      geom_col() +
      scale_fill_distiller(palette = "Reds", direction = 1, name = "Score") +
      coord_flip() +
      labs(x = "Planning Area", y = "Average Commuter Score", title = "Average Commuter Score by Planning Area") +
      theme_minimal() +
      theme(legend.position = "right",
            axis.text = element_text(size = 7),
            axis.title = element_text(size = 10),
            plot.title = element_text(size = 12, face = "bold"))
    
    ggplotly(com_chart, tooltip = "text")
  })

}
```


```{r}
shinyApp(ui, server)
```

